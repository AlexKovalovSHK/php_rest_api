name: Build and Deploy PHP REST API
on:
  push:
    branches: [ "main" ]

env:
  PHP_IMAGE: "php-rest-api"
  ARCHIVE_NAME: "images.tar"
  DEPLOY_DIR: "/var/www/php-rest-api"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Собираем PHP-образ
      - name: Build PHP image
        run: |
          docker build -t ${{ env.PHP_IMAGE }} .

      # Сохраняем образ в архив
      - name: Save image to tar
        run: |
          docker save ${{ env.PHP_IMAGE }} -o ${{ env.ARCHIVE_NAME }}

      # Устанавливаем sshpass для передачи по паролю
      - name: Install sshpass
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass

      # Копируем архив и docker-compose.yml на сервер
      - name: Deploy to Server
        run: |
          # Создаём папку на сервере
          sshpass -p "${{ secrets.SERVER_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "mkdir -p ${{ env.DEPLOY_DIR }}"

          # Копируем архив и docker-compose.yml
          sshpass -p "${{ secrets.SERVER_PASSWORD }}" scp -o StrictHostKeyChecking=no ${{ env.ARCHIVE_NAME }} docker-compose.yml ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ env.DEPLOY_DIR }}

          # На сервере: загружаем образ, перезапускаем сервис
          sshpass -p "${{ secrets.SERVER_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} '
            cd ${{ env.DEPLOY_DIR }} && \
            echo "Loading Docker image..." && \
            docker load -i ${{ env.ARCHIVE_NAME }} && \
            echo "Stopping old containers..." && \
            docker-compose down && \
            echo "Starting new containers..." && \
            docker-compose up -d && \
            echo "Cleaning up..." && \
            rm -f ${{ env.ARCHIVE_NAME }} && \
            docker image prune -f
          '